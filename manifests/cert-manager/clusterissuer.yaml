# Vault PKI ClusterIssuer for vault-aio
# Uses Vault's PKI secrets engine as the CA
---
# Service Account for cert-manager to authenticate with Vault
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-manager
  namespace: cert-manager
---
# Secret for Vault token (created by vault-init job, placeholder here)
apiVersion: v1
kind: Secret
metadata:
  name: vault-token
  namespace: cert-manager
type: Opaque
stringData:
  token: "root"
---
# Vault PKI Issuer - uses Vault's intermediate CA
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-pki-issuer
spec:
  vault:
    path: pki_int/sign/cert-manager
    server: http://vault.vault-aio.svc.cluster.local:8200
    auth:
      tokenSecretRef:
        name: vault-token
        key: token
---
# Keep the self-signed issuer as fallback during initialization
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-issuer
spec:
  selfSigned: {}
---
# Fallback CA Certificate - used until Vault PKI is ready
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-aio-ca
  namespace: cert-manager
spec:
  isCA: true
  commonName: vault-aio-ca
  secretName: vault-aio-ca-secret
  duration: 87600h # 10 years
  renewBefore: 720h # 30 days
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
# Fallback CA Issuer
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-aio-ca-issuer
spec:
  ca:
    secretName: vault-aio-ca-secret
