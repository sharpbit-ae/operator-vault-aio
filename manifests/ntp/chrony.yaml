apiVersion: v1
kind: ConfigMap
metadata:
  name: chrony-config
  namespace: vault-aio
data:
  chrony.conf: |
    # Chrony NTP configuration for Vault AIO

    # NTP servers - use pool.ntp.org
    pool pool.ntp.org iburst maxsources 4
    pool time.google.com iburst maxsources 2
    pool time.cloudflare.com iburst maxsources 2

    # Record the rate at which the system clock gains/loses time
    driftfile /var/lib/chrony/drift

    # Allow NTP client access from the cluster network
    allow 10.0.0.0/8
    allow 172.16.0.0/12
    allow 192.168.0.0/16

    # Serve time to clients even when not synchronized
    local stratum 10

    # Log files location
    logdir /var/log/chrony

    # Log measurements, statistics, tracking, rtc, refclocks, tempcomp
    log measurements statistics tracking

    # Make steps if offset is larger than 1 second (first 3 updates only)
    makestep 1.0 3

    # Enable kernel synchronisation of the real-time clock
    rtcsync

    # Enable hardware timestamping if available
    hwtimestamp *

    # Minimum number of selectable sources required to update clock
    minsources 2

    # Specify directory for Unix domain command socket
    cmdport 0

    # Disable command access from network (only local)
    bindcmdaddress 127.0.0.1
    bindcmdaddress ::1
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: chrony
  namespace: vault-aio
  labels:
    app: chrony
spec:
  selector:
    matchLabels:
      app: chrony
  template:
    metadata:
      labels:
        app: chrony
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9123"
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: chrony
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache chrony
              chronyd -d -f /etc/chrony/chrony.conf
          ports:
            - containerPort: 123
              protocol: UDP
              hostPort: 123
              name: ntp
          securityContext:
            capabilities:
              add:
                - SYS_TIME
                - NET_BIND_SERVICE
          volumeMounts:
            - name: config
              mountPath: /etc/chrony
            - name: varlib
              mountPath: /var/lib/chrony
            - name: varlog
              mountPath: /var/log/chrony
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "50m"
        # Chrony exporter for Prometheus (removed - image not available)
        # NTP synchronization will be handled by the chrony container itself
      volumes:
        - name: config
          configMap:
            name: chrony-config
        - name: varlib
          hostPath:
            path: /var/lib/chrony
            type: DirectoryOrCreate
        - name: varlog
          hostPath:
            path: /var/log/chrony
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: chrony
  namespace: vault-aio
spec:
  type: ClusterIP
  ports:
    - port: 123
      targetPort: 123
      protocol: UDP
      name: ntp
    - port: 9123
      targetPort: 9123
      name: metrics
  selector:
    app: chrony
