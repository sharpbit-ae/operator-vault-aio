---
# Vault AIO Orchestrator
# Creates a standalone Vault VM with integrated monitoring, logging, tracing, and NTP
# This playbook is self-contained - all roles are included in this repository

# Step 1: Create Vault AIO VM on hypervisor (localhost)
- name: Create Vault AIO VM
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  tasks:
    - name: Run Phase 1 - VM Creation
      include_role:
        name: vm_create
      vars:
        vm_name: "vault-aio"
        vm_hostname: "vault-aio.aeon.local"
        vm_ip_address: "10.0.0.20"
        vm_gateway: "10.0.0.1"
        vm_dns_servers: ["10.0.0.1", "8.8.8.8"]
        vm_libvirt_network: "aeon_router"
        vm_network_gateway: "10.0.0.1"
        vm_network_netmask: "255.255.255.0"
        vm_network_dhcp_start: "10.0.0.100"
        vm_network_dhcp_end: "10.0.0.199"
        vm_memory_mb: 8192  # 8 GB for full stack
        vm_vcpus: 4
        vm_disk_size_gb: 100  # Larger for logs/metrics storage
        vm_user: "aeonuser"
        vm_user_password: "changeme123"
        vm_ssh_pubkey: "{{ lookup('file', playbook_dir + '/vault-aio-key.pub') }}"
        vm_ssh_key_path: "{{ playbook_dir }}/vault-aio-key"
        create_network: false  # Network already exists

# Step 2-4: Configure Vault AIO VM
- name: Configure Vault AIO VM
  hosts: vault_aio
  become: true
  gather_facts: true

  tasks:
    - name: Wait for VM to be reachable
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

    - name: Run Phase 2 - CIS Hardening
      include_role:
        name: cis_harden

    - name: Run Phase 2.5 - WireGuard Mesh
      include_role:
        name: wireguard_mesh
      vars:
        wireguard_tunnel_ip: "10.10.10.20"
        wireguard_private_key: "{{ lookup('env', 'WIREGUARD_PRIVATE_KEY') | default(omit) }}"
        wireguard_peers: "{{ lookup('env', 'WIREGUARD_PEERS') | default([]) }}"

    - name: Run Phase 3 - k3s Installation
      include_role:
        name: k3d_install
      vars:
        k8s_cluster_name: "vault-aio"

    - name: Run Phase 4 - ArgoCD Installation
      include_role:
        name: argocd_install

# Step 5: Deploy Infrastructure Components
- name: Deploy Infrastructure Components
  hosts: vault_aio
  become: true
  gather_facts: true

  vars:
    manifests_dir: "{{ playbook_dir }}/../manifests"

  tasks:
    - name: Create manifests directory on VM
      file:
        path: /opt/vault-aio
        state: directory
        mode: '0755'

    - name: Copy manifests to VM
      synchronize:
        src: "{{ manifests_dir }}/"
        dest: /opt/vault-aio/
        recursive: yes

    - name: Install cert-manager CRDs
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.crds.yaml
      register: certmgr_crds
      retries: 3
      delay: 10
      until: certmgr_crds.rc == 0

    - name: Install cert-manager
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml
      register: certmgr_install
      retries: 3
      delay: 10
      until: certmgr_install.rc == 0

    - name: Wait for cert-manager to be ready
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl wait --for=condition=Available deployment/cert-manager -n cert-manager --timeout=120s
        kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=120s
        kubectl wait --for=condition=Available deployment/cert-manager-cainjector -n cert-manager --timeout=120s
      register: certmgr_ready
      retries: 5
      delay: 15
      until: certmgr_ready.rc == 0

    - name: Apply Traefik (kube-system namespace)
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl apply -f /opt/vault-aio/ingress/traefik.yaml
      register: traefik_result
      retries: 3
      delay: 10
      until: traefik_result.rc == 0

    - name: Wait for Traefik to be ready
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl wait --for=condition=Available deployment/traefik -n kube-system --timeout=120s
      register: traefik_ready
      retries: 5
      delay: 15
      until: traefik_ready.rc == 0

    - name: Apply cert-manager ClusterIssuer
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl apply -f /opt/vault-aio/cert-manager/clusterissuer.yaml
      register: issuer_result
      retries: 3
      delay: 10
      until: issuer_result.rc == 0

    - name: Apply Vault AIO manifests via kustomize
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl apply -k /opt/vault-aio/
      register: apply_result
      retries: 3
      delay: 10
      until: apply_result.rc == 0

    - name: Wait for Vault pod to be ready
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl wait --for=condition=Ready pod -l app=vault -n vault-aio --timeout=300s
      register: vault_ready
      retries: 5
      delay: 30
      until: vault_ready.rc == 0

    - name: Wait for Prometheus pod to be ready
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl wait --for=condition=Ready pod -l app=prometheus -n vault-aio --timeout=300s
      register: prom_ready
      retries: 5
      delay: 30
      until: prom_ready.rc == 0

    - name: Wait for Grafana pod to be ready
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl wait --for=condition=Ready pod -l app=grafana -n vault-aio --timeout=300s
      register: grafana_ready
      retries: 5
      delay: 30
      until: grafana_ready.rc == 0

    - name: Get pod status
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl get pods -n vault-aio
      register: pod_status

    - name: Display pod status
      debug:
        var: pod_status.stdout_lines

# Step 6: Initialize Vault
- name: Initialize Vault
  hosts: vault_aio
  become: true
  gather_facts: true

  tasks:
    - name: Check if Vault is initialized
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl exec -n vault-aio deploy/vault -- vault status -format=json 2>/dev/null | jq -r .initialized
      register: vault_initialized
      failed_when: false

    - name: Initialize Vault
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl exec -n vault-aio deploy/vault -- vault operator init -key-shares=5 -key-threshold=3 -format=json
      register: vault_init
      when: vault_initialized.stdout != "true"

    - name: Save Vault init output locally
      copy:
        content: "{{ vault_init.stdout }}"
        dest: "/root/vault-aio-init-{{ ansible_date_time.epoch }}.json"
        mode: '0600'
      when: vault_init is changed

    - name: Unseal Vault
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        KEY=$(echo '{{ vault_init.stdout }}' | jq -r ".unseal_keys_b64[{{ item }}]")
        kubectl exec -n vault-aio deploy/vault -- vault operator unseal "$KEY"
      loop: [0, 1, 2]
      when: vault_init is changed

    - name: Generate random passwords for basic auth
      set_fact:
        prometheus_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
        alertmanager_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
        loki_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
        tempo_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"
        grafana_password: "{{ lookup('password', '/dev/null length=24 chars=ascii_letters,digits') }}"

    - name: Create basic auth secrets
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        # Create htpasswd format secrets for Traefik basic auth
        kubectl create secret generic prometheus-basic-auth -n vault-aio \
          --from-literal=users="admin:$(openssl passwd -apr1 '{{ prometheus_password }}')" \
          --dry-run=client -o yaml | kubectl apply -f -
        kubectl create secret generic alertmanager-basic-auth -n vault-aio \
          --from-literal=users="admin:$(openssl passwd -apr1 '{{ alertmanager_password }}')" \
          --dry-run=client -o yaml | kubectl apply -f -
        kubectl create secret generic loki-basic-auth -n vault-aio \
          --from-literal=users="admin:$(openssl passwd -apr1 '{{ loki_password }}')" \
          --dry-run=client -o yaml | kubectl apply -f -
        kubectl create secret generic tempo-basic-auth -n vault-aio \
          --from-literal=users="admin:$(openssl passwd -apr1 '{{ tempo_password }}')" \
          --dry-run=client -o yaml | kubectl apply -f -
      register: basic_auth_created

    - name: Update Grafana admin password
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl create secret generic grafana-admin -n vault-aio \
          --from-literal=password='{{ grafana_password }}' \
          --dry-run=client -o yaml | kubectl apply -f -
      register: grafana_secret_updated

    - name: Restart Grafana to pick up new password
      shell: |
        export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
        kubectl rollout restart deployment/grafana -n vault-aio
      when: grafana_secret_updated is changed

    - name: Save credentials
      copy:
        content: |
          # Vault AIO Credentials
          # Generated: {{ ansible_date_time.iso8601 }}

          ## Grafana
          URL: https://grafana.vault-aio.local
          Username: admin
          Password: {{ grafana_password }}

          ## Prometheus (Basic Auth)
          URL: https://prometheus.vault-aio.local
          Username: admin
          Password: {{ prometheus_password }}

          ## Alertmanager (Basic Auth)
          URL: https://alertmanager.vault-aio.local
          Username: admin
          Password: {{ alertmanager_password }}

          ## Loki (Basic Auth)
          URL: https://loki.vault-aio.local
          Username: admin
          Password: {{ loki_password }}

          ## Tempo (Basic Auth)
          URL: https://tempo.vault-aio.local
          Username: admin
          Password: {{ tempo_password }}

          ## Vault
          URL: https://vault.vault-aio.local
          See /root/vault-aio-init-*.json for root token and unseal keys
        dest: "/root/vault-aio-credentials.txt"
        mode: '0600'

    - name: Display completion message
      debug:
        msg:
          - "=== Vault AIO Deployment Complete ==="
          - ""
          - "VM IP: 10.0.0.20"
          - "WireGuard IP: 10.10.10.20"
          - ""
          - "Access URLs (add to /etc/hosts: 10.0.0.20 vault-aio.local vault.vault-aio.local grafana.vault-aio.local prometheus.vault-aio.local):"
          - "  Homepage:    https://vault-aio.local"
          - "  Vault:       https://vault.vault-aio.local"
          - "  Grafana:     https://grafana.vault-aio.local"
          - "  Prometheus:  https://prometheus.vault-aio.local"
          - "  Alertmanager: https://alertmanager.vault-aio.local"
          - ""
          - "Credentials saved to: /root/vault-aio-credentials.txt"
          - "Vault init keys saved to: /root/vault-aio-init-*.json"
