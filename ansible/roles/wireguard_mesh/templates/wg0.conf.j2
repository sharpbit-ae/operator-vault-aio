# WireGuard Interface Configuration
# Generated by Ansible for Vault AIO
# Interface: {{ wireguard_interface }}
# Network: {{ wireguard_network }}
# Port: {{ wireguard_port }}

[Interface]
Address = {{ wireguard_tunnel_ip }}/24
ListenPort = {{ wireguard_port }}
{% if wireguard_private_key %}
PrivateKey = {{ wireguard_private_key }}
{% else %}
# Private key will be generated on first startup
# Run: wg genkey | tee /etc/wireguard/privatekey | wg pubkey > /etc/wireguard/publickey
{% endif %}

# Post-up/down scripts for routing
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT

{% if wireguard_peers %}
# Peer Configuration
{% for peer in wireguard_peers %}
[Peer]
PublicKey = {{ peer.public_key }}
AllowedIPs = {{ peer.allowed_ips | default(peer.tunnel_ip + '/32') }}
{% if peer.endpoint is defined %}
Endpoint = {{ peer.endpoint }}
{% endif %}
{% if wireguard_node_role != 'hub' and peer.persistent_keepalive | default(true) %}
PersistentKeepalive = {{ wireguard_persistent_keepalive }}
{% endif %}

{% endfor %}
{% else %}
# No peers configured - standalone mode
# Add peers manually or via inventory:
# wireguard_peers:
#   - public_key: "peer_public_key_here"
#     tunnel_ip: "10.10.10.1"
#     endpoint: "10.0.0.1:51820"
{% endif %}
