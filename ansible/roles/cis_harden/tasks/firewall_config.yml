---
# Firewall configuration tasks

- name: Install nftables
  ansible.builtin.apt:
    name: nftables
    state: present

- name: Enable and start nftables
  ansible.builtin.systemd:
    name: nftables
    enabled: yes
    state: started

- name: Configure basic nftables rules
  ansible.builtin.copy:
    content: |
      #!/usr/sbin/nft -f
      # CIS Hardening - nftables configuration

      flush ruleset

      table inet filter {
        chain input {
          type filter hook input priority 0; policy drop;

          # Allow loopback
          iif lo accept

          # Allow established/related connections
          ct state established,related accept

          # Allow ICMP (ping)
          ip protocol icmp accept
          ip6 nexthdr icmpv6 accept

          # Allow SSH (adjust port if needed)
          tcp dport {{ ssh_port }} accept

          # WireGuard VPN
          udp dport 51820 accept comment "WireGuard VPN"
          iifname wg0 accept comment "WireGuard interface traffic"

          # Drop invalid packets
          ct state invalid drop
        }

        chain forward {
          type filter hook forward priority 0; policy accept;
        }

        chain output {
          type filter hook output priority 0; policy accept;
        }
      }
    dest: /etc/nftables.conf
    mode: '0755'
    owner: root
    group: root
  notify: restart nftables
